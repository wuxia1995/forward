function uploadPicDetect(obj){for(var i=0;i<num;i++){if($("#detect"+i).length>0){$("#detect"+i).remove()}}var attributeCheckedUpload=[];$('input[name="attribute"]:checked').each(function(){console.log($(this).val());attributeCheckedUpload.push($(this).val())});var file=obj.files[0];var reader=new FileReader();reader.onload=function(e){var imgUrl=e.target.result;$("#imgShowDetect").attr("src",imgUrl);getImageWidth(imgUrl,function(widthImg,heightImg){var imgShowDiv=document.getElementById("imgShowDetectDiv");var imgShow=document.getElementById("imgShowDetect");imgShow.src=imgUrl;resizePic(imgShow,imgShowDiv,widthImg,heightImg);var detectForm=new FormData();detectForm.append("photo",file);obj.value="";for(var inx in attributeCheckedUpload){detectForm.append(attributeCheckedUpload[inx],"true")}$.ajax({url:"customer/detect-face",type:"POST",data:detectForm,processData:false,contentType:false,async:true,success:function(data){var dataObj=eval("("+data+")");if(data==""||dataObj["faces"].length==0){$("#responseDetect").html("未检查到人脸");$("#faceProperties").html("");return false}checkProperties(eval("("+data+")"));handleData($("#imgShowDetect").attr("src"),eval("("+data+")"))},error:function(data){$("#responseDetect").html("文件格式不符或文件太大");$("#faceProperties").html("");return false}})})};reader.readAsDataURL(file)}function dataURItoBlob(dataURI){var byteString=atob(dataURI.split(",")[1]);var mimeString=dataURI.split(",")[0].split(":")[1].split(";")[0];var ab=new ArrayBuffer(byteString.length);var ia=new Uint8Array(ab);for(var i=0;i<byteString.length;i++){ia[i]=byteString.charCodeAt(i)}console.log([ab]);return new Blob([ab],{type:mimeString})}function compress(img,width,height,ratio){var canvas,ctx,img64;canvas=document.createElement("canvas");canvas.width=width;canvas.height=height;ctx=canvas.getContext("2d");ctx.drawImage(img,0,0,width,height);img64=canvas.toDataURL("image/jpeg",ratio);return img64}function resizePic(imgShow,imgShowDiv,widthImg,heightImg){console.log(imgShowDiv.offsetHeight);if(heightImg!=widthImg){if(heightImg>widthImg){imgShow.style.width=widthImg/heightImg*100+"%";imgShow.style.height="100%"}if(heightImg<widthImg){imgShow.style.height=heightImg/widthImg*100+"%";imgShow.style.width="100%"}}else{imgShow.style.height="100%";imgShow.style.width="100%"}}$(document).ready(function(){});var num=0;function detectUrl(){$("#imgShowDetect").attr("src",$("#inputUrlDetect").val());detectReq($("#inputUrlDetect").val())}function detectReq(imgUrl){document.getElementById("imgShowDetect").style.height="100%";document.getElementById("imgShowDetect").style.width="100%";for(var i=0;i<num;i++){if($("#detect"+i).length>0){$("#detect"+i).remove()}}getImageWidth(imgUrl,function(widthImg,heightImg){var imgShowDiv=document.getElementById("imgShowDetectDiv");var imgShow=document.getElementById("imgShowDetect");console.log("height:"+heightImg);console.log("widht:"+widthImg);console.log(imgShowDiv.offsetHeight);if(heightImg!=widthImg){if(heightImg>widthImg){imgShow.style.width=widthImg/heightImg*100+"%";imgShow.style.height="100%"}if(heightImg<widthImg){imgShow.style.height=heightImg/widthImg*100+"%";imgShow.style.width="100%"}}else{imgShow.style.height="100%";imgShow.style.width="100%"}$("#imgShowDetect").attr("src",imgUrl)});var attributeChecked={};$('input[name="attribute"]:checked').each(function(){attributeChecked[$(this).val()]="true"});attributeChecked["photo"]=imgUrl;$.ajax({url:"customer/detect-face",type:"POST",data:attributeChecked,async:true,success:function(data){if(data==""){$("#responseDetect").html("no face detected");$("#faceProperties").html("");return false}localData=eval("("+data+")");checkProperties(localData);handleData(imgUrl,localData)},error:function(data){$("#responseDetect").html("no face detected");$("#faceProperties").html("")}})}function handleData(imgContent,data){$("#responseDetect").html(syntaxHighlight(data));var imgSrc=$("#imgShowDetect").attr("src");getImageWidth(imgSrc,function(w,h){img=document.getElementById("imgShowDetect");imgDiv=document.getElementById("imgShowDetectDiv");console.log({width:w,height:h});console.log({width:imgDiv.offsetWidth,height:imgDiv.offsetHeight});console.log({picwidth:img.naturalWidth,picheight:img.naturalWidth});hratew=img.height/img.width;var widthRate=img.width/w;var heightRate=img.height/h;var dataObj=eval(data);var rect;var results=[];if(dataObj.hasOwnProperty("faces")){rect=dataObj["faces"];for(var i=0;i<rect.length;i++){rect[i].x1=rect[i].x1*widthRate;rect[i].x2=rect[i].x2*widthRate;rect[i].y1=rect[i].y1*heightRate;rect[i].y2=rect[i].y2*heightRate;width=(rect[i].x2-rect[i].x1)*0.8;height=(rect[i].y2-rect[i].y1)*0.9;left=rect[i].x1+width*0.15;divtop=rect[i].y1+2;var result=new Result(width,height,left,divtop);results[i]=result}}if(results){for(var i=0;i<num;i++){if($("#detect"+i).length>0){$("#detect"+i).remove()}}num=results.length;for(var i=0;i<results.length;i++){$("#imgShowDetectDiv").prepend("<div id='detect"+i+"'><span style='color: #00c3bb' >"+(i+1)+"</span></div>");
$("#detect"+i).css({"position":"absolute","outline":"rgb(70, 171, 232) solid 2px","width":results[i].width,"height":results[i].height,"left":results[i].left,"top":results[i].top})}}})}function checkProperties(data){faceData=data["faces"];elementData=[];var status;for(var single in faceData){var status=null;elementData.push("<p>第"+(parseInt(single)+1)+"张人脸的属性</p>");if(faceData[single]["age"]){status=true;var age=Math.round(faceData[single]["age"]);if(age<1){age=1}elementData.push("<p>年龄:"+age+"</p>")}if(faceData[single]["emotions"]){status=true;elementData.push("<p>情绪:"+faceData[single]["emotions"]+"</p>")}if(faceData[single]["gender"]){status=true;elementData.push("<p>性别:"+faceData[single]["gender"]+"</p>")}}if(status){$("#faceProperties").html(elementData.join(""))}else{$("#faceProperties").html("")}}var leftUploadFile;var rightUploadFile;function verifyUrl(id){verifyReq($("#inputUrl"+id).val(),id)}function uploadPicVerify(obj,id){document.getElementById("imgShow"+id).style.height="100%";document.getElementById("imgShow"+id).style.width="100%";removeDiv();var img=document.getElementById("imgShow"+id);var file=obj.files[0];if(!file){return false}var reader=new FileReader();reader.onloadend=function(e){var imgUrl=e.target.result;getImageWidth(imgUrl,function(widthImg,heightImg){var imgShowDiv=document.getElementById("picDiv"+id);var imgShow=document.getElementById("imgShow"+id);console.log("height:"+heightImg);console.log("widht:"+widthImg);console.log(imgShowDiv.offsetHeight);if(heightImg!=widthImg){if(heightImg>widthImg){imgShow.style.width=widthImg/heightImg*100+"%";imgShow.style.height="100%"}if(heightImg<widthImg){imgShow.style.height=heightImg/widthImg*100+"%";imgShow.style.width="100%"}}else{imgShow.style.height="100%";imgShow.style.width="100%"}$("#imgShow"+id).attr("src",imgUrl)});img.src=e.target.result;if(id==1){leftUploadFile=file}if(id==2){rightUploadFile=file}obj.value=""};reader.readAsDataURL(file);another=id==1?2:1;var imgAno=document.getElementById("imgShow"+another);var formData=new FormData();if(imgAno.src.indexOf("data:image")==0||imgAno.src.indexOf("data:;base64")==0){formData.append("photo1",file);if(id==1){formData.append("photo2",rightUploadFile)}else{if(id==2){formData.append("photo2",leftUploadFile)}else{return false}}}else{formData.append("photo1",file);formData.append("photo2",imgAno.src)}$.ajax({url:"customer/verify-face",type:"POST",data:formData,processData:false,contentType:false,async:true,success:function(data){var dataObj=eval("("+data+")");if(data==""){$("#resultVerify").html("有图片未检测到人脸");$("#reponseVerify").html("有图片未检测到人脸");return false}readResData(dataObj,id)},error:function(data){removeDiv();$("#resultVerify").html("图片未检查到人脸或文件格式不符或文件太大");$("#reponseVerify").html("");return false}})}function readResData(data,id){removeDiv();console.log(data);var dataObj=eval(data);$("#reponseVerify").html(syntaxHighlight(data));var confidence=dataObj["results"]["0"]["confidence"];var val=dataObj["verified"];var rect1=dataObj["results"]["0"]["bbox1"];var rect2=dataObj["results"]["0"]["bbox2"];console.log(rect1);console.log(rect2);var imgshow1=document.getElementById("imgShow1");var imgshow2=document.getElementById("imgShow2");if(id==1){getImageWidth(imgshow1.src,function(w,h){drawDiv(imgshow1,w,h,rect1,"picDiv1")});getImageWidth(imgshow2.src,function(w,h){drawDiv(imgshow2,w,h,rect2,"picDiv2")})}else{getImageWidth(imgshow1.src,function(w,h){drawDiv(imgshow1,w,h,rect2,"picDiv1")});getImageWidth(imgshow2.src,function(w,h){drawDiv(imgshow2,w,h,rect1,"picDiv2")})}$("#resultVerify").html("是同一张人脸的可信度是:<br>"+confidence)}function drawDiv(image,w,h,result,parentId){var imgVerifyDiv=document.getElementById(parentId);var widthRate=image.width/w;var heightRate=image.height/h;result.x1=result.x1*widthRate;result.x2=result.x2*widthRate;result.y1=result.y1*heightRate;result.y2=result.y2*heightRate;width=(result.x2-result.x1)*0.8;height=(result.y2-result.y1)*0.9;left=result.x1+width*0.15;divtop=result.y1+2;picId=image.id+"1";$("#"+parentId).prepend("<div id='"+picId+"'></div>");$("#"+picId).css({"position":"absolute","outline":"rgb(70, 171, 232) solid 2px","width":width,"height":height,"left":left,"top":divtop})}function verifyReq(imgUrl,id){document.getElementById("imgShow"+id).style.height="100%";document.getElementById("imgShow"+id).style.width="100%";removeDiv();getImageWidth(imgUrl,function(widthImg,heightImg){var imgShowDiv=document.getElementById("picDiv"+id);var imgShow=document.getElementById("imgShow"+id);console.log("height:"+heightImg);console.log("widht:"+widthImg);console.log(imgShowDiv.offsetHeight);if(heightImg!=widthImg){if(heightImg>widthImg){imgShow.style.width=widthImg/heightImg*100+"%";imgShow.style.height="100%"}if(heightImg<widthImg){imgShow.style.height=heightImg/widthImg*100+"%";imgShow.style.width="100%"}}else{imgShow.style.height="100%";imgShow.style.width="100%"}$("#imgShow"+id).attr("src",imgUrl);var notId=id==1?2:1;var selfImg=document.getElementById("imgShow"+id);var anotherImg=document.getElementById("imgShow"+notId);
var formData=new FormData();if(anotherImg.src.indexOf("data:image")==0||anotherImg.src.indexOf("data:;base64")==0){formData.append("photo1",selfImg.src);if(id==1){formData.append("photo2",rightUploadFile)}else{if(id==2){formData.append("photo2",leftUploadFile)}else{return false}}}else{formData.append("photo1",selfImg.src);formData.append("photo2",anotherImg.src)}$.ajax({url:"customer/verify-face",type:"POST",data:formData,processData:false,contentType:false,async:true,success:function(data){if(data==""){$("#resultVerify").html("有图片未检测到人脸");$("#reponseVerify").html("有图片未检测到人脸");return false}readResData(eval("("+data+")"),id)},error:function(data){$("#resultVerify").html("文件格式不符或文件太大");$("#reponseVerify").html("");return false}})})}var preSize=0;function searchUrlDemo(input){if($("#inputUrlSearchDemo").val()==""){alert("url不能为空");return false}$("#imgShowSearchDemo").attr("src",$("#inputUrlSearchDemo").val());var img=new Image();img.src=$("#inputUrlSearchDemo").val();searchReqDemo(img)}function searchReqDemo(img){document.getElementById("imgShowSearchDemo").style.height="100%";document.getElementById("imgShowSearchDemo").style.width="100%";getImageWidth(img.src,function(widthImg,heightImg){var imgShowDiv=document.getElementById("imgShowSearchDemoDiv");var imgShow=document.getElementById("imgShowSearchDemo");console.log("height:"+heightImg);console.log("widht:"+widthImg);console.log(imgShowDiv.offsetHeight);if(heightImg!=widthImg){if(heightImg>widthImg){imgShow.style.width=widthImg/heightImg*100+"%";imgShow.style.height="100%"}if(heightImg<widthImg){imgShow.style.height=heightImg/widthImg*100+"%";imgShow.style.width="100%"}}else{imgShow.style.height="100%";imgShow.style.width="100%"}});var formData=new FormData();formData.append("n",4);formData.append("photo",img.src);$.ajax({url:"customer/getDemoFace",type:"POST",data:formData,processData:false,contentType:false,async:true,success:function(data){if(data==""||data.length==0){$("#reponseSearchDemo").html("");$("#searchResultDemo").html("图库中未搜索相似人脸");$("#resultShowSearchDemo").html("");return false}$("#imgShowSearchDemo").attr("src",img.src);dataObj=eval(data);showResult(dataObj);$("#reponseSearchDemo").html(syntaxHighlight(filter(dataObj)))},error:function(data){$("#reponseSearchDemo").html("");$("#resultShowSearchDemo").html("未在库中搜索到相似人脸或图片格式不符");$("#searchResultDemo").html("");return false}})}function removeBefore(size){for(var i=1;i<=size;i++){if($("#div"+i)){$("#div"+i).remove()}if($("#divResult"+i)){$("#divResult"+i).remove()}}}function uploadImgSearcheDemo(img){document.getElementById("imgShowSearchDemo").style.height="100%";document.getElementById("imgShowSearchDemo").style.width="100%";var imgShow=document.getElementById("imgShowSearchDemo");var file=img.files[0];if(!file){return false}var reader=new FileReader();reader.onload=function(e){imgShow.src=e.target.result;getImageWidth(imgShow.src,function(widthImg,heightImg){var imgShowDiv=document.getElementById("imgShowSearchDemoDiv");console.log("height:"+heightImg);console.log("widht:"+widthImg);console.log(imgShowDiv.offsetHeight);if(heightImg!=widthImg){if(heightImg>widthImg){imgShow.style.width=widthImg/heightImg*100+"%";imgShow.style.height="100%"}if(heightImg<widthImg){imgShow.style.height=heightImg/widthImg*100+"%";imgShow.style.width="100%"}}else{imgShow.style.height="100%";imgShow.style.width="100%"}})};reader.readAsDataURL(file);var formData=new FormData();formData.append("n",3);formData.append("photo",file);img.value="";$.ajax({url:"customer/getDemoFace",type:"POST",data:formData,processData:false,contentType:false,async:true,success:function(data){if(data==""||data.length==0){$("#reponseSearchDemo").html("");$("#searchResultDemo").html("图库中未搜索相似人脸");$("#resultShowSearchDemo").html("")}dataObj=eval(data);showResult(dataObj);$("#reponseSearchDemo").html(syntaxHighlight(filter(dataObj)))},error:function(data){$("#reponseSearchDemo").html("");$("#searchResultDemo").html("未在库中搜索到相似人脸或图片格式不符");$("#resultShowSearchDemo").html("");return false}})}function showResult(dataObj){$("#searchResultDemo").html("");$("#resultShowSearchDemo").html("");removeBefore(preSize);preSize=0;for(var v in dataObj){preSize++;var imgEle="<div>第"+preSize+"张</div>"+"<div class='graphic_img4'><img src='"+dataObj[v]["face"]["normalized"]+"'></div>";var confidence="第"+preSize+"张是同一个人的可信度是:"+dataObj[v]["confidence"];$("#searchResultDemo").append("<div  id='divResult"+preSize+"'>"+confidence+"</div>");$("#resultShowSearchDemo").append("<div class='results_graphic4'  class='imgboxShow' id='div"+preSize+"'>"+imgEle+"</div>")}}function filter(data){if(data.length==0){return false}for(var obj in data){data[obj]["face"].normalized="normalizedUrl"}return data}function removeDiv(){if($("#imgShow11")){$("#imgShow11").remove()}if($("#imgShow21")){$("#imgShow21").remove()}}function Result(width,height,left,top){this.width=width;this.height=height;this.left=left;this.top=top}function getImageWidth(url,callback){var img=new Image();img.src=url;
if(img.complete){callback(img.width,img.height)}else{img.onload=function(){callback(img.width,img.height)}}}function syntaxHighlight(json){if(typeof json!="string"){json=JSON.stringify(json,undefined,2)}json=json.replace(/&/g,"&").replace(/</g,"<").replace(/>/g,">");return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,function(match){var cls="number";if(/^"/.test(match)){if(/:$/.test(match)){cls="key"}else{cls="string"}}else{if(/true|false/.test(match)){cls="boolean"}else{if(/null/.test(match)){cls="null"}}}return match})};
